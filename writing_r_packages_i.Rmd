---
title: "Writing R Packages"
output:
  html_document: 
    toc: true
    toc_float: true
---

text

This is the first module in the [Writing R Packages](topic_r_packages.html) topic; the relevant slack channel is [here](https://p8105-fall2017.slack.com/messages/C86A5JU9L).

```{r, echo = FALSE}
knitr::opts_chunk$set(
  eval = FALSE,
  collapse = TRUE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
```


## Some slides

<script async class="speakerdeck-embed" data-id="3f91d97c70e641cea46366ac9d90c929" data-ratio="1.33333333333333" src="//speakerdeck.com/assets/embed.js"></script>
<div style="margin-bottom:5px"> <strong> <a href="https://speakerdeck.com/jeffgoldsmith/dsi-writing-functions" title="Writing Functions" target="_blank">Writing Functions</a> </strong> from <strong><a href="https://speakerdeck.com/jeffgoldsmith" target="_blank">Jeff Goldsmith</a></strong>. </div><br>


## Example

Before jumping into organization, I want to revisit a recurring example from [Iteration](topic_iteration.html).

Wrote a function to simulate from SLR and return n and estimates. 

```{r}
sim_regression = function(n_samp, beta0, beta1) {
  
  sim_data = tibble(
    x = rnorm(n_samp, mean = 1, sd = 1),
    y = beta0 + beta1 * x + rnorm(n_samp, 0, 1)
  )
  
  ls_fit = lm(y ~ x, data = sim_data)
  
  tibble(
    n = n_samp,
    beta0_hat = coef(ls_fit)[1],
    beta1_hat = coef(ls_fit)[2]
  )
}
```

Also wrote a function to repeat that nrep times and format output as a data frame. 

```{r}
simulate_nrep = function(n_rep, n_samp, beta0, beta1) {
  
  rerun(n_rep, sim_regression(n_samp, beta0, beta1)) %>% 
    bind_rows()
  
}
```

You can download R scripts containing [`sim_regression`](./resources/sim_regression.R) and [`simulate_nreps`](./resources/simulate_nrep.R). 

These functions were used in the following context.

```{r}
library(broom)
library(tidyverse)

sim_results = 
  map_df(list(30, 60, 120, 240), simulate_nrep,
         n_rep = 10, beta0 = 2, beta1 = 3) 
```

That's our motivation -- we have two functions, and it's time to write a package!


### `create()`

I'm going to create a new package using `devtools::create()`. I'm calling this `example.package`; you might want to call yours something else. 

```{r}
library(devtools)
create("~/Desktop/example.package")
```

(**Note**: you might have thought I was going to call this `example_package` in keeping with _literally everything else in the whole course_. You'd be right; that's exactly what I was going to do. But early on CRAN decided not to let underscores in package names and that's one of those things that just probably won't change. Putting `.`s in package names causes other problems and I would usuall avoid it, but it seemed like the best option in this case. So here we are, stuck with `example.package`.)

Contains `DESCRIPTION`, `NAMESPACE`, an empty `R` directory, and an R Project. 

Open R Project, find build tab -- RStudio has some helpful built-in tools for package development. 


### Add functions

add functions. install and restart. 

Run the code below.

```{r}
library(broom)
library(tidyverse)
library(example.package)

rm(list = ls())

simulate_nrep(n_rep = 10, n_samp = 30, beta0 = 2, beta1 = 3) 
```

Note -- functions aren't defined in the global environment now, like they had been before. They're coming from the package. That's great!!

Now try `?simulate_nrep`. There's nothing there because we haven't written the documentation yet, so that's our next step. 


### Add documentation

Put cursor in the function; go to Code > Insert Roxygen Skeleton. 

Update title, write a short summary of the function, input parameter descriptions, and return description (ignore export for now). Do the same for the other function.

Use devtools::document(), or use the drop-down menu. install and restart. 

open the directory for the package. should have a new `man` subdirectory, with files for each function with the extension `.Rd`. These are the documentation files; you can open them if you want, but don't edit these! Change your documentation in the roxygen stuff; keeps your functions and documentation in the same place, which is easier to keep up to date.

Double check the code above still works, and try `?simulate_nrep` again. 

add an example (based on what we've been doing), build and reload. 

As you're writing documentation, keep in mind that you'll need to understand this later -- this is another case where you're collaborating with "future you", so anything you do now to make this clear will save you time later! If you intend to share this with others, you probably need to be even more explicit in your documentation. 


### Package description

Go ahead and edit the package description. There's a lot here, some of which really only matters if you plan to share this with others. Nonetheless, fill it in. Many folks start with version number `0.1.0`; Jeff Leek's guide has some nice thoughts about [versioning](https://github.com/jtleek/rpackages#versioning-your-package) based on Bioconductor. 

This is also a good time to put a license on it -- run the line below and change `LICENSE.txt` to your name and the current year. 

```{r}
devtools::use_mit_license()
```

Install and restart. 

### More functions

My package now consists of a function to simulate data from a SLR, estimate model parameters, and return the results, and a second function that reruns the first, formats the results, and returns a dataframe. This general structure could be extended to other simulation designs.

The function below has the same general structure as `sim_regression()` but instead simulates data from a Bernoulli distribution and returns the sample average (script [here](./resources/sim_bern_mean.R).

```{r}
sim_bern_mean = function(n_samp, prob) {
  
  sim_data = tibble(
    y = rbinom(n_samp, 1, prob)
  )
  
  tibble(
    n = n_samp,
    samp_avg = mean(sim_data$y)
  )
}
```

I'll add this to my package, write some documentation, use `document()`, and install + restart. I can then check that this works the way I want.

```{r}
library(broom)
library(tidyverse)
library(example.package)

rm(list = ls())

sim_bern_mean(25, .9)
```

A problem now is that `simulate_nrep` doesn't take advantage of this new function, so I need to do some rewrites there. Specifically, I'll let `sim_func` be an argument and use `...`. New function is below. 

```{r}
simulate_nrep = function(n_rep, sim_func, ...) {
  
  rerun(n_rep, sim_func(...)) %>% 
    bind_rows()
  
}
```

I'll add this, change the documentation accordingly, `document()`, install and restart. Now I can do the following. 

```{r}
library(broom)
library(tidyverse)
library(example.package)

rm(list = ls())

simulate_nrep(10, sim_regression, n_samp = 30, beta0 = 2, beta1 = 3)
```


### Dependencies

Note that we've depended on broom, tidyverse. If I opened a new R session, loaded my package, and tried to run it, I'd get an error. We'll talk more about why this is later; for now we'll just note that our package depends on those packages. Add those to dependencies to roxygen, document() check namespace. 

Also need to add this to the `DESCRIPTION`. Could do "by hand" since `document()` doesn't touch this; instead we'll run the following lines in the console. Check Description before and after!

```{r}
devtools::use_package("tidyverse")
devtools::use_package("broom")
```

Best practices would also use `tidyverse::fun()` and `broom::fun()` everywhere to make it really clear where packages are coming from; this does make a difference sometimes, although I have to say I'm not great at doing this. 


### Deploy on GitHub

Throughout I've been using GH because that's how to do my usual development. Turns out there's another helpful thing -- you can install packages from GH!! Try installing my package using the lines below.

```{r}
devtools::install_github(repo = "jeff-goldsmith/example.package")
```


### README

Helpful to put a short README especially if other people will need this. Files named `README.md` are handled in a special way by GH, and can be a useful way to give people a quick overview of your package without them having to install it and read the documentation first. 

Create a template using

```{r}
devtools::use_readme_rmd()
```

Make some edits (I like to include installation instructions that can be copy-and-pasted).

then knit, push, and check out the GH repo!


## Other materials

* https://hilaryparker.com/2014/04/29/writing-an-r-package-from-scratch/
* https://github.com/jtleek/rpackages
* http://stat545.com/packages00_index.html, http://stat545.com/cm109-110-notes_and_exercises.html, and 
http://stat545.com/packages06_foofactors-package.html
* http://r-pkgs.had.co.nz/intro.html and http://r-pkgs.had.co.nz/package.html; maybe http://r-pkgs.had.co.nz/r.html, http://r-pkgs.had.co.nz/description.html, http://r-pkgs.had.co.nz/man.html,

The code that I produced working examples in lecture is [here](...).