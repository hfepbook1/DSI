<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Writing R Packages</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-1.1/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-1.1/highlight.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}

.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Data Science I</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Topics
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="topic_what_is_data_science.html">What is Data Science?</a>
    </li>
    <li>
      <a href="topic_building_blocks.html">Building Blocks</a>
    </li>
    <li>
      <a href="topic_data_wrangling_i.html">Data Wrangling I</a>
    </li>
    <li>
      <a href="topic_visualization_and_eda.html">Visualization and EDA</a>
    </li>
    <li>
      <a href="topic_collaboration.html">Collaboration</a>
    </li>
    <li>
      <a href="topic_data_wrangling_ii.html">Data Wrangling II</a>
    </li>
    <li>
      <a href="topic_interactivity.html">Interactivity</a>
    </li>
    <li>
      <a href="topic_iteration.html">Iteration</a>
    </li>
    <li>
      <a href="topic_r_packages.html">R Packages</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Datasets
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="dataset_mr_trash_wheel.html">Mr. Trash Wheel</a>
    </li>
    <li>
      <a href="dataset_restaurant_inspections.html">NYC Restaurant Inspections</a>
    </li>
    <li>
      <a href="dataset_instacart.html">Instacart</a>
    </li>
    <li>
      <a href="dataset_fivethirtyeight.html">FiveThirtyEight</a>
    </li>
    <li>
      <a href="dataset_noaa.html">NOAA</a>
    </li>
    <li>
      <a href="dataset_airbnb.html">Airbnb</a>
    </li>
  </ul>
</li>
<li>
  <a href="homework_and_projects.html">Homework and Projects</a>
</li>
<li>
  <a href="course_communication.html">Communication</a>
</li>
<li>
  <a href="http://github.com/jeff-goldsmith/DSI/">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Writing R Packages</h1>

</div>


<p>If you write more than two functions, you need a package – this will remind you what functions do and how they interact with each other, help you keep track of inputs and outputs, and, if you want to share you code, allow you to do so in a standard format. This module will take us from a few functions to a complete package.</p>
<p>This is the first module in the <a href="topic_r_packages.html">Writing R Packages</a> topic; the relevant slack channel is <a href="https://p8105-fall2017.slack.com/messages/C86A5JU9L">here</a>.</p>
<div id="some-slides" class="section level2">
<h2>Some slides</h2>
<script async class="speakerdeck-embed" data-id="3f91d97c70e641cea46366ac9d90c929" data-ratio="1.33333333333333" src="//speakerdeck.com/assets/embed.js"></script>
<div style="margin-bottom:5px">
<strong> <a href="https://speakerdeck.com/jeffgoldsmith/dsi-writing-functions" title="Writing Functions" target="_blank">Writing Functions</a> </strong> from <strong><a href="https://speakerdeck.com/jeffgoldsmith" target="_blank">Jeff Goldsmith</a></strong>.
</div>
<p><br></p>
</div>
<div id="example" class="section level2">
<h2>Example</h2>
<p>Rather than jumping into how to organize this material, we’ll start by motivating the need for an R package by revisiting an example from <a href="topic_iteration.html">Iteration</a>. There, we wrote a short function to simulate data from a simple linear regression; this function returns a data frame containing the sample size and estimated coefficients for the simualted dataset.</p>
<pre class="r"><code>sim_regression = function(n_samp, beta0, beta1) {
  
  sim_data = tibble(
    x = rnorm(n_samp, mean = 1, sd = 1),
    y = beta0 + beta1 * x + rnorm(n_samp, 0, 1)
  )
  
  ls_fit = lm(y ~ x, data = sim_data)
  
  tibble(
    n = n_samp,
    beta0_hat = coef(ls_fit)[1],
    beta1_hat = coef(ls_fit)[2]
  )
}</code></pre>
<p>We also wrote a wrapper function to repeat the simulation many times and collapse the output to a data frame.</p>
<pre class="r"><code>simulate_nrep = function(n_rep, n_samp, beta0, beta1) {
  
  rerun(n_rep, sim_regression(n_samp, beta0, beta1)) %&gt;% 
    bind_rows()
  
}</code></pre>
<p>You can download R scripts containing <a href="./resources/sim_regression.R"><code>sim_regression</code></a> and <a href="./resources/simulate_nrep.R"><code>simulate_nreps</code></a>.</p>
<p>We used these functions to examine the properties of ordinary least squares estimates in a simple linear regression.</p>
<pre class="r"><code>library(broom)
library(tidyverse)

sim_results = 
  map_df(list(30, 60, 120, 240), simulate_nrep,
         n_rep = 100, beta0 = 2, beta1 = 3) 

sim_results %&gt;% 
  mutate(n = as.factor(n),
         n = fct_relabel(n, relabel_function)) %&gt;% 
  ggplot(aes(x = beta0_hat, y = beta1_hat)) + 
  geom_point(alpha = .2) + 
  facet_grid(~n)</code></pre>
<p>It’s really easy to forget what these functions do and how to work with them, even in the space of a couple of weeks. In this case it’s not <em>too</em> bad to look back at the code, but for more complex functions it can be very challenging. That’s why writing packages is helpful.</p>
<div id="create" class="section level3">
<h3><code>create()</code></h3>
<p>I’ll create a new package skeleton called <code>example.package</code> using <code>devtools::create()</code>.</p>
<pre class="r"><code>library(devtools)
create(&quot;~/Desktop/example.package&quot;)</code></pre>
<p>(<strong>Note</strong>: you might have thought I was going to call this <code>example_package</code> in keeping with <em>literally everything else in the whole course</em>. You’d be right; that’s exactly what I was going to do. But early on CRAN decided not to let underscores in package names and that’s one of those things that just probably won’t change. Putting <code>.</code>s in package names causes other problems and I would usuall avoid it, but it seemed like the best option in this case. So here we are, stuck with <code>example.package</code>.)</p>
<p>Take a look at the directory that <code>create()</code> creates. This contains <code>DESCRIPTION</code> and <code>NAMESPACE</code> files, an empty <code>R</code> directory, and an R Project – everything you need to get a package started.</p>
<p>Open the R Project, and notice the build tab. RStudio has a lot of helpful built-in tools for package development, which we’ll use frequently. Like other things we’ve seen, these are often shortcuts for commands that do the same stuff.</p>
</div>
<div id="add-functions" class="section level3">
<h3>Add functions</h3>
<p>My “package” currently doesn’t do anything, so I’m going to copy the <code>.R</code> files above into the <code>R</code> directory. Then I’ll install this version of the package and restart the R session, and run the code below.</p>
<pre class="r"><code>library(broom)
library(tidyverse)
library(example.package)

rm(list = ls())

simulate_nrep(n_rep = 10, n_samp = 30, beta0 = 2, beta1 = 3) </code></pre>
<p>I’ve removed the functions from the global environment, but can still run the code above. That’s because we’ve made those functions accessible to R through <code>example.package</code>, which is great!!</p>
<p>If you try <code>?sim_regression</code> you’ll find there’s nothing there; that’s because we haven’t written any documentation. Putting all your functions in a package keeps them from cluttering up your scripts and R Markdown documents, but packages aren’t really useful without documentation.</p>
</div>
<div id="add-documentation" class="section level3">
<h3>Add documentation</h3>
<p>Open <code>sim_regression.R</code> and put your cursor somewhere inside the function. Go to Code &gt; Insert Roxygen Skeleton; this will add a bunch of commented lines above the function. We’ll use the <code>roxygen2</code> package to convert these specially formatted lines into the file <code>man/sim_regression.Rd</code>, which will become the help page accessed using <code>?sim_regression</code>.</p>
<p>After updating the title, writing a short summary of the function, describing input parameters and the return object (ignore <code>@export</code> and <code>@examples</code> for now), you should have something like the following:</p>
<pre class="r"><code>#&#39; Simulate from an SLR
#&#39;
#&#39; Simualtes data from a simple linear regression model with user-defined
#&#39; sample size and regression coefficients. Fits a SLR to the simulated 
#&#39; data and returns regression coefficients.
#&#39;
#&#39; @param n_samp sample size
#&#39; @param beta0 intercept
#&#39; @param beta1 slope
#&#39;
#&#39; @return tbl_df with one row, containing sample size and coef estimates
#&#39; @export
#&#39;
#&#39; @examples</code></pre>
<p>Repeat this process to create a roxygen comments for <code>simulate_nrep</code>.</p>
<p>Once the roxygen comments are in place, use <code>devtools::document()</code> or Build &gt; More &gt; Document to create help pages for the two functions. Install and restart, and try <code>?sim_regression</code> again. Now you have help pages accessible in the usual way – neat!!</p>
<p>Open the directory for the package. You should find a new <code>man</code> subdirectory, with files for each function with the extension <code>.Rd</code>. These are the documentation files; you can open them if you want, but don’t edit them! Always change your documentation in the roxygen comments – doing so keeps your functions and documentation in the same place, which makes it easier to stay organized and up to date.</p>
<p>These descriptions are helpful, but illustrative examples are great too! Edit the roxygen comments to include the lines below, then <code>devtools::document()</code>, install + rebuild, and check out the new help page.</p>
<pre class="r"><code>#&#39; @examples
#&#39; sim_regression(30, 2, 3)</code></pre>
<p>As you writing documentation, keep in mind that you’ll need to understand how your functions work later – this is another case where you’re collaborating with “future you”, so anything you do now to make this clear will save you time in the long run! If you intend to share this with others, you probably need to be even more explicit in your documentation.</p>
</div>
<div id="package-description" class="section level3">
<h3>Package description</h3>
<p>Go ahead and edit the package description. There’s a lot here, some of which really only matters if you plan to share this with others. Nonetheless, fill it in. Many folks start with version number <code>0.1.0</code>; Jeff Leek’s guide has some nice thoughts about <a href="https://github.com/jtleek/rpackages#versioning-your-package">versioning</a> based on Bioconductor.</p>
<p>This is also a good time to put a license on it – run the line below and change <code>LICENSE.txt</code> to your name and the current year.</p>
<pre class="r"><code>devtools::use_mit_license()</code></pre>
<p>Install and restart.</p>
</div>
<div id="more-functions" class="section level3">
<h3>More functions</h3>
<p>My package now consists of a function to simulate data from a SLR, estimate model parameters, and return the results, and a second function that reruns the first, formats the results, and returns a dataframe. This general structure could be extended to other simulation designs.</p>
<p>The function below has the same general structure as <code>sim_regression()</code> but instead simulates data from a Bernoulli distribution and returns the sample average (script <a href="./resources/sim_bern_mean.R">here</a>.</p>
<pre class="r"><code>sim_bern_mean = function(n_samp, prob) {
  
  sim_data = tibble(
    y = rbinom(n_samp, 1, prob)
  )
  
  tibble(
    n = n_samp,
    samp_avg = mean(sim_data$y)
  )
}</code></pre>
<p>I’ll add this to my package, write some documentation, use <code>document()</code>, and install + restart. I can then check that this works the way I want.</p>
<pre class="r"><code>library(broom)
library(tidyverse)
library(example.package)

rm(list = ls())

sim_bern_mean(25, .9)</code></pre>
<p>A problem now is that <code>simulate_nrep</code> doesn’t take advantage of this new function, so I need to do some rewrites there. Specifically, I’ll let <code>sim_func</code> be an argument and use <code>...</code>. New function is below.</p>
<pre class="r"><code>simulate_nrep = function(n_rep, sim_func, ...) {
  
  rerun(n_rep, sim_func(...)) %&gt;% 
    bind_rows()
  
}</code></pre>
<p>I’ll add this, change the documentation accordingly, <code>document()</code>, install and restart. Now I can do the following.</p>
<pre class="r"><code>library(broom)
library(tidyverse)
library(example.package)

rm(list = ls())

simulate_nrep(10, sim_regression, n_samp = 30, beta0 = 2, beta1 = 3)</code></pre>
</div>
<div id="dependencies" class="section level3">
<h3>Dependencies</h3>
<p>Note that we’ve depended on broom, tidyverse. If I opened a new R session, loaded my package, and tried to run it, I’d get an error. We’ll talk more about why this is later; for now we’ll just note that our package depends on those packages. Add those to dependencies to roxygen, document() check namespace.</p>
<p>Also need to add this to the <code>DESCRIPTION</code>. Could do “by hand” since <code>document()</code> doesn’t touch this; instead we’ll run the following lines in the console. Check Description before and after!</p>
<pre class="r"><code>devtools::use_package(&quot;tidyverse&quot;)
devtools::use_package(&quot;broom&quot;)</code></pre>
<p>Best practices would also use <code>tidyverse::fun()</code> and <code>broom::fun()</code> everywhere to make it really clear where packages are coming from; this does make a difference sometimes, although I have to say I’m not great at doing this.</p>
</div>
<div id="deploy-on-github" class="section level3">
<h3>Deploy on GitHub</h3>
<p>Throughout I’ve been using GH because that’s how to do my usual development. Turns out there’s another helpful thing – you can install packages from GH!! Try installing my package using the lines below.</p>
<pre class="r"><code>devtools::install_github(repo = &quot;jeff-goldsmith/example.package&quot;)</code></pre>
</div>
<div id="readme" class="section level3">
<h3>README</h3>
<p>Helpful to put a short README especially if other people will need this. Files named <code>README.md</code> are handled in a special way by GH, and can be a useful way to give people a quick overview of your package without them having to install it and read the documentation first.</p>
<p>Create a template using</p>
<pre class="r"><code>devtools::use_readme_rmd()</code></pre>
<p>Make some edits (I like to include installation instructions that can be copy-and-pasted).</p>
<p>then knit, push, and check out the GH repo!</p>
</div>
</div>
<div id="other-materials" class="section level2">
<h2>Other materials</h2>
<ul>
<li><a href="https://hilaryparker.com/2014/04/29/writing-an-r-package-from-scratch/" class="uri">https://hilaryparker.com/2014/04/29/writing-an-r-package-from-scratch/</a></li>
<li><a href="https://github.com/jtleek/rpackages" class="uri">https://github.com/jtleek/rpackages</a></li>
<li><a href="http://stat545.com/packages00_index.html" class="uri">http://stat545.com/packages00_index.html</a>, <a href="http://stat545.com/cm109-110-notes_and_exercises.html" class="uri">http://stat545.com/cm109-110-notes_and_exercises.html</a>, and <a href="http://stat545.com/packages06_foofactors-package.html" class="uri">http://stat545.com/packages06_foofactors-package.html</a></li>
<li><a href="http://r-pkgs.had.co.nz/intro.html" class="uri">http://r-pkgs.had.co.nz/intro.html</a> and <a href="http://r-pkgs.had.co.nz/package.html" class="uri">http://r-pkgs.had.co.nz/package.html</a>; maybe <a href="http://r-pkgs.had.co.nz/r.html" class="uri">http://r-pkgs.had.co.nz/r.html</a>, <a href="http://r-pkgs.had.co.nz/description.html" class="uri">http://r-pkgs.had.co.nz/description.html</a>, <a href="http://r-pkgs.had.co.nz/man.html" class="uri">http://r-pkgs.had.co.nz/man.html</a>,</li>
</ul>
<p>The code that I produced working examples in lecture is <a href="...">here</a>.</p>
</div>

<br><br>
<footer>
    <p class="copyright text-muted" align="center">Copyright &copy; 2017 Jeff Goldsmith</p>
</footer>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
