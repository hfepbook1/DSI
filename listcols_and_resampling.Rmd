---
title: "List Columns and Bootstrapping"
output:
  html_document: 
    toc: true
    toc_float: true
---

text

This is the third module in the [Iteration](topic_iteration.html) topic; the relevant slack channel is [here](https://p8105-fall2017.slack.com/messages/C7WC2UPT7).

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
```


## Some slides

<script async class="speakerdeck-embed" data-id="ee17524f046c49a58cec601fb98bb72d" data-ratio="1.33333333333333" src="//speakerdeck.com/assets/embed.js"></script>
<div style="margin-bottom:5px"> <strong> <a href="https://speakerdeck.com/jeffgoldsmith/dsi-tidy-text" title="Tidy Text" target="_blank">Tidy Data</a> </strong> from <strong><a href="https://speakerdeck.com/jeffgoldsmith" target="_blank">Jeff Goldsmith</a></strong>. </div><br>


## Example

I'll write code for today's content in a new R Markdown document called `listcols_and_resampling.Rmd` in the `example_iteration` directory / repo. The code chunk below loads the usual packages.


```{r}
library(tidyverse)

theme_set(theme_bw())
theme_update(legend.position = "bottom")
```


things are gonna get weird.

### nest weather data

```{r weather_data_create, cache = TRUE}
library(rnoaa)

weather = 
  meteo_pull_monitors(c("USW00094728", "USC00519397", "USS0023B17S"),
                      var = c("PRCP", "TMIN", "TMAX"), 
                      date_min = "2016-01-01",
                      date_max = "2016-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY", 
                      USC00519397 = "Waikiki_HA",
                      USS0023B17S = "Waterhole_WA"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```


```{r}
weather = 
  nest(weather, date:tmin)

weather
```


```{r}
weather$data[[1]]
```

### operations on list columns

```{r}
weather_lm = function(df) {
  lm(tmax ~ tmin, data = df)
}
```

```{r}
weather_lm(weather$data[[1]])
```

```{r}
map(weather$data, weather_lm)
```

```{r}
weather = 
  weather %>% 
  mutate(models = map(data, weather_lm))

weather
```

```{r}
weather = 
  weather %>% 
  mutate(results = map(models, broom::tidy)) %>% 
  select(-data, -models) %>% 
  unnest()

weather
```


### Instacart data

same process but faster


### bootstrapping

Why bootstrap

simulate data coming from a model with increasing variance

point out that OLS estimates will understate variance. 

bootstrapping can help here (note: WLS would also work, and might be better).

### BS samples as list col

```{r, eval = FALSE}
boot_sample = function(df) {
  sample_n(df)
}

boot_straps = data_frame(
  strap_number = 1:100,
  strap_sample = boot_sample(sim_data)
)
```

fit models

extract results

make some plots

### `bootstrap`

Show how this works using `bootstrap()`



## Other materials


* http://r4ds.had.co.nz/many-models.html
* https://stackoverflow.com/questions/45101045/why-use-purrrmap-instead-of-lapply 
* https://jennybc.github.io/purrr-tutorial/
* https://drsimonj.svbtle.com/k-fold-cross-validation-with-modelr-and-broom
* http://rpubs.com/dgrtwo/cv-modelr
* https://cran.r-project.org/web/packages/broom/vignettes/broom_and_dplyr.html
* https://github.com/tidyverse/broom/blob/master/vignettes/bootstrapping.Rmd
* https://github.com/tidyverse/modelr
The code that I produced working examples in lecture is [here](ZZZZZ).
